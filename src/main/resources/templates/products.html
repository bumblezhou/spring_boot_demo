<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <th:block th:replace="~{fragments/bootstrap_ref :: bootstrap_css_js}" />
    <th:block th:replace="~{fragments/vuejs_ref :: vue_js}" />
</head>
<body>
<div th:replace="~{fragments/navigation :: navigation}"></div>
<div id="app" class="container mt-5">
    <h2>Product Management</h2>

    <!-- Add Product Button -->
    <button class="btn btn-primary my-3" @click="openModal(null)">Add Product</button>

    <!-- Products Table with Pagination -->
    <h3>Product List</h3>
    <table class="table table-bordered mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Type</th>
                <th>Supplier</th>
                <th>Price</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="product in products" :key="product.id">
                <td>{{ product.id }}</td>
                <td>{{ product.name }}</td>
                <td>{{ getProductTypeName(product.productTypeId) }}</td>
                <td>{{ getSupplierName(product.supplierId) }}</td>
                <td>{{ product.price }}</td>
                <td>
                    <button class="btn btn-sm btn-warning" @click="openModal(product)">Edit</button>
                    <button class="btn btn-sm btn-danger" @click="deleteProduct(product.id)">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <nav>
        <ul class="pagination">
            <li class="page-item" :class="{ disabled: currentPage === 0 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage - 1)">Previous</a>
            </li>
            <li class="page-item" v-for="page in totalPages" :key="page" :class="{ active: currentPage === page - 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(page - 1)">{{ page }}</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages - 1 }">
                <a class="page-link" href="#" @click.prevent="changePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>

    <!-- Product Modal (Add/Edit) -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form @submit.prevent="saveProduct" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productModalLabel">{{ isEdit ? 'Edit Product' : 'Add Product' }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" v-model="product.id">

                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" v-model="product.name" required>
                        </div>

                        <div class="mb-3">
                            <label for="productType" class="form-label">Product Type</label>
                            <select class="form-select" v-model="product.productTypeId" required>
                                <option v-for="type in productTypes" :value="type.id">{{ type.name }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="supplier" class="form-label">Supplier</label>
                            <select class="form-select" v-model="product.supplierId" required>
                                <option v-for="supplier in suppliers" :value="supplier.id">{{ supplier.name }}</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" v-model="product.price" step="0.01" required>
                        </div>

                        <div class="mb-3">
                            <label for="imageFile" class="form-label">Upload Image</label>
                            <input type="file" class="form-control" @change="uploadImage">
                        </div>

                        <div class="mb-3">
                            <label for="imageUrl" class="form-label">Image URL</label>
                            <input type="text" class="form-control" v-model="product.imageUrl" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="specifications" class="form-label">Specifications</label>
                            <textarea class="form-control" v-model="product.specifications" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="detailsUrl" class="form-label">Details URL</label>
                            <input type="url" class="form-control" v-model="product.detailsUrl" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" v-model="product.description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">{{ isEdit ? 'Update' : 'Add' }} Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const products = ref([]);
            const productTypes = ref([]);
            const suppliers = ref([]);
            const product = ref({
                id: null,
                productTypeId: '',
                supplierId: '',
                name: '',
                price: '',
                imageUrl: '',
                specifications: '',
                detailsUrl: '',
                description: ''
            });
            const currentPage = ref(0); // Start from 0
            const pageSize = 10;
            const totalPages = ref(0);
            const totalProducts = ref(0);
            const isEdit = ref(false);

            // Load products, product types, and suppliers on mount
            onMounted(() => {
                loadProducts();
                loadProductTypes();
                loadSuppliers();
            });

            const loadProducts = () => {
                axios.get(`/api/products/fetchItemsByPage?page=${currentPage.value}&size=${pageSize}`)
                    .then(response => {
                        products.value = response.data.content;
                        totalProducts.value = response.data.totalElements;
                        totalPages.value = response.data.totalPages;
                    })
                    .catch(error => {
                        console.error('Error loading products:', error);
                    });
            };

            const loadProductTypes = () => {
                axios.get('/api/product_types')
                    .then(response => {
                        productTypes.value = response.data;
                    })
                    .catch(error => {
                        console.error('Error loading product types:', error);
                    });
            };

            const loadSuppliers = () => {
                axios.get('/api/suppliers')
                    .then(response => {
                        suppliers.value = response.data;
                    })
                    .catch(error => {
                        console.error('Error loading suppliers:', error);
                    });
            };

            const getProductTypeName = (id) => {
                const type = productTypes.value.find(type => type.id === id);
                return type ? type.name : 'Unknown';
            };

            const getSupplierName = (id) => {
                const supplier = suppliers.value.find(supplier => supplier.id === id);
                return supplier ? supplier.name : 'Unknown';
            };

            const saveProduct = () => {
                if (product.value.id) {
                    axios.put(`/api/products/${product.value.id}`, product.value)
                        .then(() => {
                            loadProducts();
                            closeModal();
                        })
                        .catch(error => {
                            console.error('Error updating product:', error);
                        });
                } else {
                    axios.post('/api/products', product.value)
                        .then(() => {
                            loadProducts();
                            closeModal();
                        })
                        .catch(error => {
                            console.error('Error adding product:', error);
                        });
                }
            };

            const deleteProduct = (id) => {
                if (confirm('Are you sure you want to delete this product?')) {
                    axios.delete(`/api/products/${id}`)
                        .then(() => {
                            loadProducts();
                        })
                        .catch(error => {
                            console.error('Error deleting product:', error);
                        });
                }
            };

            const openModal = (prod) => {
                if (prod) {
                    product.value = { ...prod };
                    isEdit.value = true;
                } else {
                    resetForm();
                    isEdit.value = false;
                }
                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
            };

            const closeModal = () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
            };

            const resetForm = () => {
                product.value = {
                    id: null,
                    productTypeId: '',
                    supplierId: '',
                    name: '',
                    price: '',
                    imageUrl: '',
                    specifications: '',
                    detailsUrl: '',
                    description: ''
                };
            };

            const uploadImage = (event) => {
                const file = event.target.files[0];
                const formData = new FormData();
                formData.append('file', file);

                axios.post('/api/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                })
                .then(response => {
                    product.value.imageUrl = response.data.url;
                })
                .catch(error => {
                    console.error('Error uploading image:', error);
                });
            };

            const changePage = (page) => {
                if (page >= 0 && page < totalPages.value) {
                    currentPage.value = page;
                    loadProducts();
                }
            };

            return {
                products,
                productTypes,
                suppliers,
                product,
                currentPage,
                totalPages,
                isEdit,
                saveProduct,
                deleteProduct,
                openModal,
                closeModal,
                uploadImage,
                getProductTypeName,
                getSupplierName,
                changePage,
                resetForm
            };
        }
    }).mount('#app');
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
